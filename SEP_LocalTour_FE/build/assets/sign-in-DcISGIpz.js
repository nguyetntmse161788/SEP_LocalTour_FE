import{g as W,a as N,r,R as A,U as F,b as D,_ as M,V as O,c as m,j as n,p as T,e as U,s as $,k as z,W as J,X as S,Y as R,B,f as j,F as _,J as G,l as L,I as k,D as H,H as V}from"./index-DUX23g0E.js";import{C as Y}from"./config-global-BwHnWRtc.js";import{a as X}from"./index-Br0q4W-C.js";import{T as E}from"./TextField-DgaCIWDs.js";import{C as q}from"./CircularProgress-bDShaXvv.js";import"./Select-CoLeV2jR.js";import"./InputLabel-6HE52FsW.js";function K(t){return W("MuiLoadingButton",t)}const c=N("MuiLoadingButton",["root","loading","loadingIndicator","loadingIndicatorCenter","loadingIndicatorStart","loadingIndicatorEnd","endIconLoadingEnd","startIconLoadingStart"]),Q=["children","disabled","id","loading","loadingIndicator","loadingPosition","variant"],Z=t=>{const{loading:o,loadingPosition:l,classes:g}=t,p={root:["root",o&&"loading"],startIcon:[o&&`startIconLoading${T(l)}`],endIcon:[o&&`endIconLoading${T(l)}`],loadingIndicator:["loadingIndicator",o&&`loadingIndicator${T(l)}`]},d=U(p,K,g);return m({},g,d)},oo=t=>t!=="ownerState"&&t!=="theme"&&t!=="sx"&&t!=="as"&&t!=="classes",to=$(z,{shouldForwardProp:t=>oo(t)||t==="classes",name:"MuiLoadingButton",slot:"Root",overridesResolver:(t,o)=>[o.root,o.startIconLoadingStart&&{[`& .${c.startIconLoadingStart}`]:o.startIconLoadingStart},o.endIconLoadingEnd&&{[`& .${c.endIconLoadingEnd}`]:o.endIconLoadingEnd}]})(({ownerState:t,theme:o})=>m({[`& .${c.startIconLoadingStart}, & .${c.endIconLoadingEnd}`]:{transition:o.transitions.create(["opacity"],{duration:o.transitions.duration.short}),opacity:0}},t.loadingPosition==="center"&&{transition:o.transitions.create(["background-color","box-shadow","border-color"],{duration:o.transitions.duration.short}),[`&.${c.loading}`]:{color:"transparent"}},t.loadingPosition==="start"&&t.fullWidth&&{[`& .${c.startIconLoadingStart}, & .${c.endIconLoadingEnd}`]:{transition:o.transitions.create(["opacity"],{duration:o.transitions.duration.short}),opacity:0,marginRight:-8}},t.loadingPosition==="end"&&t.fullWidth&&{[`& .${c.startIconLoadingStart}, & .${c.endIconLoadingEnd}`]:{transition:o.transitions.create(["opacity"],{duration:o.transitions.duration.short}),opacity:0,marginLeft:-8}})),no=$("span",{name:"MuiLoadingButton",slot:"LoadingIndicator",overridesResolver:(t,o)=>{const{ownerState:l}=t;return[o.loadingIndicator,o[`loadingIndicator${T(l.loadingPosition)}`]]}})(({theme:t,ownerState:o})=>m({position:"absolute",visibility:"visible",display:"flex"},o.loadingPosition==="start"&&(o.variant==="outlined"||o.variant==="contained")&&{left:o.size==="small"?10:14},o.loadingPosition==="start"&&o.variant==="text"&&{left:6},o.loadingPosition==="center"&&{left:"50%",transform:"translate(-50%)",color:(t.vars||t).palette.action.disabled},o.loadingPosition==="end"&&(o.variant==="outlined"||o.variant==="contained")&&{right:o.size==="small"?10:14},o.loadingPosition==="end"&&o.variant==="text"&&{right:6},o.loadingPosition==="start"&&o.fullWidth&&{position:"relative",left:-10},o.loadingPosition==="end"&&o.fullWidth&&{position:"relative",right:-10})),eo=r.forwardRef(function(o,l){const g=r.useContext(A),p=F(g,o),d=D({props:p,name:"MuiLoadingButton"}),{children:x,disabled:I=!1,id:y,loading:u=!1,loadingIndicator:f,loadingPosition:P="center",variant:b="text"}=d,C=M(d,Q),e=O(y),s=f??n.jsx(q,{"aria-labelledby":e,color:"inherit",size:16}),a=m({},d,{disabled:I,loading:u,loadingIndicator:s,loadingPosition:P,variant:b}),i=Z(a),h=u?n.jsx(no,{className:i.loadingIndicator,ownerState:a,children:s}):null;return n.jsxs(to,m({disabled:I||u,id:e,ref:l},C,{variant:b,classes:i,ownerState:a,children:[a.loadingPosition==="end"?x:h,a.loadingPosition==="end"?h:x]}))});function so(){const t=J(),[o,l]=r.useState(""),[g,p]=r.useState(""),[d,x]=r.useState(!1),[I,y]=r.useState(!1),[u,f]=r.useState(""),P=r.useCallback(async()=>{const e=S.get("refreshToken");if(!e)return null;try{const s=await X.post("https://api.localtour.space/api/Authen/refreshToken",{refreshToken:e});console.log("response",s.data);const{accessToken:a,refreshToken:i}=s.data;return localStorage.setItem("accessToken",a),S.set("refreshToken",i,{expires:7,path:"/"}),a}catch(s){return console.error("Refresh token failed:",s),null}},[]);r.useEffect(()=>{const e=localStorage.getItem("accessToken"),s=localStorage.getItem("user"),a=localStorage.getItem("currentPath")||"/";if(e&&s)try{const i=R(e),h=Math.floor(Date.now()/1e3);i.exp&&i.exp>h?t.replace(a):P().then(v=>{v?t.replace(a):(localStorage.clear(),t.push("/sign-in"))})}catch(i){console.error("Invalid token:",i),localStorage.clear(),t.push("/sign-in")}},[t,P]);const b=r.useCallback(async()=>{y(!0),f("");try{const e=await fetch("https://api.localtour.space/api/Authen/login",{method:"POST",headers:{Accept:"*/*","Content-Type":"application/json"},body:JSON.stringify({phoneNumber:o,password:g})});if(!e.ok)throw new Error("Failed to sign in");const s=await e.json();localStorage.setItem("accessToken",s.accessToken),localStorage.setItem("userId",s.userId),S.set("refreshToken",s.refreshToken,{expires:7,path:"/"});const a=R(s.accessToken),i=Array.isArray(a["http://schemas.microsoft.com/ws/2008/06/identity/claims/role"])?a["http://schemas.microsoft.com/ws/2008/06/identity/claims/role"]:[a["http://schemas.microsoft.com/ws/2008/06/identity/claims/role"]],h=["Administrator","Moderator","Service Owner"],v=i.filter(w=>h.includes(w));if(v.length===0)throw new Error("You do not have permission to access this page");localStorage.setItem("user",JSON.stringify(s)),localStorage.setItem("role",JSON.stringify(v)),localStorage.setItem("currentPath","/"),t.replace("/")}catch(e){f(e.message||"Invalid phone number or password")}finally{y(!1)}},[o,g,t]),C=n.jsxs(B,{display:"flex",flexDirection:"column",alignItems:"flex-end",children:[n.jsx(E,{fullWidth:!0,name:"phoneNumber",label:"Phone Number",value:o,onChange:e=>l(e.target.value),InputLabelProps:{shrink:!0},sx:{mb:3}}),n.jsx(E,{fullWidth:!0,name:"password",label:"Password",value:g,onChange:e=>p(e.target.value),InputLabelProps:{shrink:!0},type:d?"text":"password",InputProps:{endAdornment:n.jsx(G,{position:"end",children:n.jsx(L,{onClick:()=>x(!d),edge:"end",children:n.jsx(k,{icon:d?"solar:eye-bold":"solar:eye-closed-bold"})})})},sx:{mb:3}}),u&&n.jsx(j,{color:"error",sx:{mb:2},children:u}),n.jsx(eo,{fullWidth:!0,size:"large",type:"button",color:"inherit",variant:"contained",onClick:b,loading:I,children:"Sign in"})]});return n.jsxs(n.Fragment,{children:[n.jsxs(B,{gap:1.5,display:"flex",flexDirection:"column",alignItems:"center",sx:{mb:5},children:[n.jsx(j,{variant:"h5",children:"Sign in"}),n.jsxs(j,{variant:"body2",color:"text.secondary",children:["Donâ€™t have an account?",n.jsx(_,{variant:"subtitle2",sx:{ml:.5},children:"Get started"})]})]}),C,n.jsx(H,{sx:{my:3,"&::before, &::after":{borderTopStyle:"dashed"}},children:n.jsx(j,{variant:"overline",sx:{color:"text.secondary",fontWeight:"fontWeightMedium"},children:"OR"})}),n.jsxs(B,{gap:1,display:"flex",justifyContent:"center",children:[n.jsx(L,{color:"inherit",children:n.jsx(k,{icon:"logos:google-icon"})}),n.jsx(L,{color:"inherit",children:n.jsx(k,{icon:"eva:github-fill"})}),n.jsx(L,{color:"inherit",children:n.jsx(k,{icon:"ri:twitter-x-fill"})})]})]})}function ho(){return n.jsxs(n.Fragment,{children:[n.jsx(V,{children:n.jsxs("title",{children:[" ",`Sign in - ${Y.appName}`]})}),n.jsx(so,{})]})}export{ho as default};
