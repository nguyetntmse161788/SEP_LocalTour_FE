import{j as e,B as v,T as k,w as N,A as w,h as y,l as T,x as B,I as S,y as U,r as i,z as I,H as F}from"./index-D4PwaD5N.js";import{C as A}from"./config-global-DYC5wpSI.js";import{c as P,d as h,T as E,a as O,e as D}from"./TableRow-B7nkHKsf.js";import{U as $}from"./user-table-head-_jQga8ae.js";import{O as z}from"./Select-545m9gIo.js";import{I as L}from"./InputAdornment-BfKJzYYN.js";import{T as C,a as J}from"./TableSortLabel-CWuwd1kD.js";import{a as M,g as H,e as W}from"./utils-C5x2pCfd.js";import{C as G}from"./Card-CkOvGVvy.js";import"./useFormControl-BxpVqGaN.js";import"./Popper-ChwOFtB3.js";import"./LastPage-B1ewK7Uw.js";function Q({searchQuery:a,...n}){return e.jsx(P,{...n,children:e.jsx(h,{align:"center",colSpan:7,children:e.jsxs(v,{sx:{py:15,textAlign:"center"},children:[e.jsx(k,{variant:"h6",sx:{mb:1},children:"Not found"}),e.jsxs(k,{variant:"body2",children:["No results found for Â ",e.jsxs("strong",{children:['"',a,'"']}),".",e.jsx("br",{})," Try checking for typos or using complete words."]})]})})})}function _({row:a,selected:n,onSelectRow:p}){const t=N(),m=async(c,l,s)=>{console.log(a);try{const o=localStorage.getItem("accessToken");if(!o){alert("No token found. Please log in."),t("/sign-in");return}const d=JSON.parse(atob(o.split(".")[1])),x=Math.floor(Date.now()/1e3);if(d.exp<x){alert("Token has expired. Please log in again."),localStorage.removeItem("accessToken"),t("/login");return}const u=(await T.get(`https://api.localtour.space/api/User/getProfile?userId=${c}`,{headers:{Authorization:`Bearer ${o}`}})).data;t("/admin/role",{state:{user:u,userId:c,username:l,roles:s}})}catch(o){console.error("Failed to fetch user profile:",o),alert("Error fetching user profile. Please try again.")}console.log("Updated Roles:",s),console.log("Roles from localStorage:",s)},j=async c=>{try{const l=localStorage.getItem("accessToken");if(!l){alert("No token found. Please log in."),t("/sign-in");return}const s=JSON.parse(atob(l.split(".")[1])),o=Math.floor(Date.now()/1e3);if(s.exp<o){alert("Token has expired. Please log in again."),localStorage.removeItem("accessToken"),t("/login");return}const d=`https://api.localtour.space/api/User/UnBan/${c}`;console.log("Unban URL:",d),(await T.post(d,{},{headers:{Authorization:`Bearer ${l}`}})).status===200?(alert("User has been unbanned successfully."),window.location.reload()):alert("Failed to unban user. Please try again.")}catch(l){console.error("Error unbanning user:",l),alert("Error unbanning user. Please try again.")}},f=async(c,l,s)=>{try{const o=localStorage.getItem("accessToken");if(!o){alert("No token found. Please log in."),t("/sign-in");return}const d=JSON.parse(atob(o.split(".")[1])),x=Math.floor(Date.now()/1e3);if(d.exp<x){alert("Token has expired. Please log in again."),localStorage.removeItem("accessToken"),t("/sign-in");return}const r=await T.get(`https://api.localtour.space/api/User/getProfile?userId=${c}`,{headers:{Authorization:`Bearer ${o}`}});if(r.status===200){const u=r.data;t("/admin/ban",{state:{user:u,userId:c,username:l,endDate:s}})}else alert("User profile not found. Please try again.")}catch(o){console.error("Failed to fetch user profile:",o),alert("Error fetching user profile. Please try again.")}};return e.jsxs(P,{hover:!0,tabIndex:-1,role:"checkbox",selected:n,children:[e.jsx(h,{children:e.jsx(w,{alt:a.fullName,src:a.profilePictureUrl})}),e.jsx(h,{children:a.username}),e.jsx(h,{children:a.email}),e.jsx(h,{children:a.fullName}),e.jsx(h,{children:a.phoneNumber}),e.jsx(h,{children:a.roles.join(", ")}),e.jsxs(h,{children:[e.jsx(y,{variant:"outlined",color:"primary",sx:{margin:"0 5px"},onClick:()=>m(a.id,a.username,a.roles),children:"Set Role"}),e.jsx(y,{variant:"outlined",color:"error",sx:{margin:"0 5px"},onClick:()=>f(a.id,a.username,a.endDate),children:"Ban"}),e.jsx(y,{variant:"outlined",color:"success",sx:{margin:"0 5px"},onClick:()=>j(a.id),children:"Unban"})]})]})}function q({emptyRows:a,height:n,sx:p,...t}){return a?e.jsx(P,{sx:{...n&&{height:n*a},...p},...t,children:e.jsx(h,{colSpan:9})}):null}function K({numSelected:a,filterName:n,onFilterName:p}){return e.jsxs(B,{sx:{height:96,display:"flex",justifyContent:"space-between",p:t=>t.spacing(0,1,0,3),...a>0&&{color:"primary.main",bgcolor:"primary.lighter"}},children:[a>0?e.jsxs(k,{component:"div",variant:"subtitle1",children:[a," selected"]}):e.jsx(z,{fullWidth:!0,value:n,onChange:p,placeholder:"Search user...",startAdornment:e.jsx(L,{position:"start",children:e.jsx(S,{width:20,icon:"eva:search-fill",sx:{color:"text.disabled"}})}),sx:{maxWidth:320}}),a>0?e.jsx(C,{title:"Delete",children:e.jsx(U,{children:e.jsx(S,{icon:"solar:trash-bin-trash-bold"})})}):e.jsx(C,{title:"Filter list",children:e.jsx(U,{children:e.jsx(S,{icon:"ic:round-filter-list"})})})]})}function X(){const a=N(),[n,p]=i.useState([]),[t,m]=i.useState(!0),[j,f]=i.useState(""),[c,l]=i.useState(""),s=Y();i.useEffect(()=>{const r=localStorage.getItem("accessToken");if(!r){f("No access token found. Please log in."),m(!1),a("/login");return}const u=JSON.parse(atob(r.split(".")[1])),g=Math.floor(Date.now()/1e3);if(u.exp<g){f("Token has expired. Please log in again."),m(!1),a("/sign-in");return}o(r)},[a]);const o=async r=>{try{const u=await T.get("https://api.localtour.space/api/User/getlist",{headers:{Authorization:`Bearer ${r}`}});console.log("Fetched Users:",u.data),p([...u.data])}catch{f("Failed to fetch users")}finally{m(!1)}},d=M({inputData:n,comparator:H(s.order,s.orderBy),filterName:c}),x=!d.length&&!!c;return t?e.jsx("div",{children:"Loading..."}):e.jsx(v,{sx:{p:3},children:e.jsxs(G,{children:[e.jsx(K,{filterName:c,onFilterName:r=>{l(r.target.value),s.onResetPage()},numSelected:0}),e.jsx(I,{children:e.jsx(E,{sx:{overflow:"unset"},children:e.jsxs(O,{sx:{minWidth:800},children:[e.jsx($,{order:s.order,orderBy:s.orderBy,rowCount:n.length,numSelected:s.selected.length,onSort:s.onSort,headLabel:[{id:"avatar",label:"Avatar"},{id:"username",label:"User name"},{id:"email",label:"Email"},{id:"fullname",label:"Full Name"},{id:"phone",label:"Phone"},{id:"role",label:"Role"},{id:"button",label:"Action"}]}),e.jsxs(D,{children:[t&&e.jsx(P,{children:e.jsx(h,{colSpan:8,align:"center",children:"Loading..."})}),j&&e.jsx(P,{children:e.jsx(h,{colSpan:8,align:"center",sx:{color:"error.main"},children:j})}),d.slice(s.page*s.rowsPerPage,s.page*s.rowsPerPage+s.rowsPerPage).map(r=>e.jsx(_,{row:r,selected:s.selected.includes(r.id),onSelectRow:()=>s.onSelectRow(r.id)},r.id)),e.jsx(q,{height:68,emptyRows:W(s.page,s.rowsPerPage,n.length)}),x&&e.jsx(Q,{searchQuery:c})]})]})})}),e.jsx(J,{component:"div",page:s.page,count:n.length,rowsPerPage:s.rowsPerPage,onPageChange:s.onChangePage,rowsPerPageOptions:[5,10,25],onRowsPerPageChange:s.onChangeRowsPerPage})]})})}function Y(){const[a,n]=i.useState(0),[p,t]=i.useState("username"),[m,j]=i.useState(5),[f,c]=i.useState([]),[l,s]=i.useState("asc"),o=i.useCallback(g=>{s(p===g&&l==="asc"?"desc":"asc"),t(g)},[l,p]),d=i.useCallback(g=>{c(b=>b.includes(g)?b.filter(R=>R!==g):[...b,g])},[]),x=i.useCallback(()=>n(0),[]),r=i.useCallback((g,b)=>{n(b)},[]),u=i.useCallback(g=>{j(parseInt(g.target.value,10)),x()},[x]);return{page:a,order:l,orderBy:p,rowsPerPage:m,selected:f,onSort:o,onSelectRow:d,onResetPage:x,onChangePage:r,onChangeRowsPerPage:u}}function de(){return e.jsxs(e.Fragment,{children:[e.jsx(F,{children:e.jsxs("title",{children:[" ",`Users - ${A.appName}`]})}),e.jsx(X,{})]})}export{de as default};
