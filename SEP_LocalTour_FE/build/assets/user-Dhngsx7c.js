import{j as e,B as v,f as k,K as N,A as w,k as S,N as B,J as I,I as T,O as U,l as C,r as i,S as F,H as A}from"./index-DUX23g0E.js";import{C as O}from"./config-global-BwHnWRtc.js";import{a as y}from"./index-Br0q4W-C.js";import{T as P,a as h,b as E,c as D,d as $,e as J}from"./TableSortLabel-2OFHYdxw.js";import{a as L,g as z,U as M,e as H}from"./user-table-head-CpeZQUce.js";import{O as W}from"./Select-CoLeV2jR.js";import{C as G}from"./Card-CfNpMCOC.js";import"./LastPage-B31ot4Y2.js";function K({searchQuery:a,...o}){return e.jsx(P,{...o,children:e.jsx(h,{align:"center",colSpan:7,children:e.jsxs(v,{sx:{py:15,textAlign:"center"},children:[e.jsx(k,{variant:"h6",sx:{mb:1},children:"Not found"}),e.jsxs(k,{variant:"body2",children:["No results found for Â ",e.jsxs("strong",{children:['"',a,'"']}),".",e.jsx("br",{})," Try checking for typos or using complete words."]})]})})})}function Q({row:a,selected:o,onSelectRow:p}){const t=N(),f=async(c,l,s)=>{console.log(a);try{const n=localStorage.getItem("accessToken");if(!n){alert("No token found. Please log in."),t("/sign-in");return}const d=JSON.parse(atob(n.split(".")[1])),x=Math.floor(Date.now()/1e3);if(d.exp<x){alert("Token has expired. Please log in again."),localStorage.removeItem("accessToken"),t("/login");return}const u=(await y.get(`https://api.localtour.space/api/User/getProfile?userId=${c}`,{headers:{Authorization:`Bearer ${n}`}})).data;t("/admin/role",{state:{user:u,userId:c,username:l,roles:s}})}catch(n){console.error("Failed to fetch user profile:",n),alert("Error fetching user profile. Please try again.")}console.log("Updated Roles:",s),console.log("Roles from localStorage:",s)},j=async c=>{try{const l=localStorage.getItem("accessToken");if(!l){alert("No token found. Please log in."),t("/sign-in");return}const s=JSON.parse(atob(l.split(".")[1])),n=Math.floor(Date.now()/1e3);if(s.exp<n){alert("Token has expired. Please log in again."),localStorage.removeItem("accessToken"),t("/login");return}const d=`https://api.localtour.space/api/User/UnBan/${c}`;console.log("Unban URL:",d),(await y.post(d,{},{headers:{Authorization:`Bearer ${l}`}})).status===200?(alert("User has been unbanned successfully."),window.location.reload()):alert("Failed to unban user. Please try again.")}catch(l){console.error("Error unbanning user:",l),alert("Error unbanning user. Please try again.")}},m=async(c,l,s)=>{try{const n=localStorage.getItem("accessToken");if(!n){alert("No token found. Please log in."),t("/sign-in");return}const d=JSON.parse(atob(n.split(".")[1])),x=Math.floor(Date.now()/1e3);if(d.exp<x){alert("Token has expired. Please log in again."),localStorage.removeItem("accessToken"),t("/sign-in");return}const r=await y.get(`https://api.localtour.space/api/User/getProfile?userId=${c}`,{headers:{Authorization:`Bearer ${n}`}});if(r.status===200){const u=r.data;t("/admin/ban",{state:{user:u,userId:c,username:l,endDate:s}})}else alert("User profile not found. Please try again.")}catch(n){console.error("Failed to fetch user profile:",n),alert("Error fetching user profile. Please try again.")}};return e.jsxs(P,{hover:!0,tabIndex:-1,role:"checkbox",selected:o,children:[e.jsx(h,{children:e.jsx(w,{alt:a.fullName,src:a.profilePictureUrl})}),e.jsx(h,{children:a.username}),e.jsx(h,{children:a.email}),e.jsx(h,{children:a.fullName}),e.jsx(h,{children:a.phoneNumber}),e.jsx(h,{children:a.roles.join(", ")}),e.jsxs(h,{children:[e.jsx(S,{variant:"outlined",color:"primary",sx:{margin:"0 5px"},onClick:()=>f(a.id,a.username,a.roles),children:"Set Role"}),e.jsx(S,{variant:"outlined",color:"error",sx:{margin:"0 5px"},onClick:()=>m(a.id,a.username,a.endDate),children:"Ban"}),e.jsx(S,{variant:"outlined",color:"success",sx:{margin:"0 5px"},onClick:()=>j(a.id),children:"Unban"})]})]})}function _({emptyRows:a,height:o,sx:p,...t}){return a?e.jsx(P,{sx:{...o&&{height:o*a},...p},...t,children:e.jsx(h,{colSpan:9})}):null}function q({numSelected:a,filterName:o,onFilterName:p}){return e.jsxs(B,{sx:{height:96,display:"flex",justifyContent:"space-between",p:t=>t.spacing(0,1,0,3),...a>0&&{color:"primary.main",bgcolor:"primary.lighter"}},children:[a>0?e.jsxs(k,{component:"div",variant:"subtitle1",children:[a," selected"]}):e.jsx(W,{fullWidth:!0,value:o,onChange:p,placeholder:"Search user...",startAdornment:e.jsx(I,{position:"start",children:e.jsx(T,{width:20,icon:"eva:search-fill",sx:{color:"text.disabled"}})}),sx:{maxWidth:320}}),a>0?e.jsx(U,{title:"Delete",children:e.jsx(C,{children:e.jsx(T,{icon:"solar:trash-bin-trash-bold"})})}):e.jsx(U,{title:"Filter list",children:e.jsx(C,{children:e.jsx(T,{icon:"ic:round-filter-list"})})})]})}function X(){const a=N(),[o,p]=i.useState([]),[t,f]=i.useState(!0),[j,m]=i.useState(""),[c,l]=i.useState(""),s=Y();i.useEffect(()=>{const r=localStorage.getItem("accessToken");if(!r){m("No access token found. Please log in."),f(!1),a("/login");return}const u=JSON.parse(atob(r.split(".")[1])),g=Math.floor(Date.now()/1e3);if(u.exp<g){m("Token has expired. Please log in again."),f(!1),a("/sign-in");return}n(r)},[a]);const n=async r=>{try{const u=await y.get("https://api.localtour.space/api/User/getlist",{headers:{Authorization:`Bearer ${r}`}});console.log("Fetched Users:",u.data),p([...u.data])}catch{m("Failed to fetch users")}finally{f(!1)}},d=L({inputData:o,comparator:z(s.order,s.orderBy),filterName:c}),x=!d.length&&!!c;return t?e.jsx("div",{children:"Loading..."}):e.jsx(v,{sx:{p:3},children:e.jsxs(G,{children:[e.jsx(q,{filterName:c,onFilterName:r=>{l(r.target.value),s.onResetPage()},numSelected:0}),e.jsx(F,{children:e.jsx(E,{sx:{overflow:"unset"},children:e.jsxs(D,{sx:{minWidth:800},children:[e.jsx(M,{order:s.order,orderBy:s.orderBy,rowCount:o.length,numSelected:s.selected.length,onSort:s.onSort,headLabel:[{id:"avatar",label:"Avatar"},{id:"username",label:"User name"},{id:"email",label:"Email"},{id:"fullname",label:"Full Name"},{id:"phone",label:"Phone"},{id:"role",label:"Role"},{id:"button",label:"Action"}]}),e.jsxs($,{children:[t&&e.jsx(P,{children:e.jsx(h,{colSpan:8,align:"center",children:"Loading..."})}),j&&e.jsx(P,{children:e.jsx(h,{colSpan:8,align:"center",sx:{color:"error.main"},children:j})}),d.slice(s.page*s.rowsPerPage,s.page*s.rowsPerPage+s.rowsPerPage).map(r=>e.jsx(Q,{row:r,selected:s.selected.includes(r.id),onSelectRow:()=>s.onSelectRow(r.id)},r.id)),e.jsx(_,{height:68,emptyRows:H(s.page,s.rowsPerPage,o.length)}),x&&e.jsx(K,{searchQuery:c})]})]})})}),e.jsx(J,{component:"div",page:s.page,count:o.length,rowsPerPage:s.rowsPerPage,onPageChange:s.onChangePage,rowsPerPageOptions:[5,10,25],onRowsPerPageChange:s.onChangeRowsPerPage})]})})}function Y(){const[a,o]=i.useState(0),[p,t]=i.useState("username"),[f,j]=i.useState(5),[m,c]=i.useState([]),[l,s]=i.useState("asc"),n=i.useCallback(g=>{s(p===g&&l==="asc"?"desc":"asc"),t(g)},[l,p]),d=i.useCallback(g=>{c(b=>b.includes(g)?b.filter(R=>R!==g):[...b,g])},[]),x=i.useCallback(()=>o(0),[]),r=i.useCallback((g,b)=>{o(b)},[]),u=i.useCallback(g=>{j(parseInt(g.target.value,10)),x()},[x]);return{page:a,order:l,orderBy:p,rowsPerPage:f,selected:m,onSort:n,onSelectRow:d,onResetPage:x,onChangePage:r,onChangeRowsPerPage:u}}function oe(){return e.jsxs(e.Fragment,{children:[e.jsx(A,{children:e.jsxs("title",{children:[" ",`Users - ${O.appName}`]})}),e.jsx(X,{})]})}export{oe as default};
