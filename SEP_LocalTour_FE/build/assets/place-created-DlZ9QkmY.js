import{r as n,j as e,k as M,y as B,B as V,f as z,I as G,S as H,H as _}from"./index-DX4RbbSE.js";import{C as Q}from"./config-global-BwHnWRtc.js";import{a as F}from"./index-Br0q4W-C.js";import{a as q,g as J,P as K,b as Y,c as U,T as X,e as Z,d as ee}from"./place-table-toolbar-CdaErI7c.js";import{D as $,a as O,b as E,c as ae}from"./DialogTitle-DE4LLfYA.js";import{T as P}from"./TextField-BBj8J8HQ.js";import{A as te}from"./Autocomplete-buUGsI1M.js";import{G as W}from"./Grid-CpEp-njR.js";import{C as se}from"./Card-DhZeIV4e.js";import{d as ne,e as oe,f as le,g as re}from"./TableSortLabel-BeKEmkrD.js";import"./Checkbox-CP06dHPC.js";import"./Select-Bj2xuOC5.js";import"./LastPage-qsknSfb6.js";const ce=({latitude:h,longitude:m,onLocationSelect:x,onCloseMap:o})=>{const r=n.useRef(null),[w,j]=n.useState(!1),[b,T]=n.useState(null),[k,S]=n.useState(null),[v,f]=n.useState([]),[L,I]=n.useState("");n.useEffect(()=>{const t=()=>{window.vietmapgl?j(!0):setTimeout(t,500)};t()},[]),n.useEffect(()=>{if(w){const t=new window.vietmapgl.Map({container:r.current,style:"https://maps.vietmap.vn/mt/tm/style.json?apikey=9e37b843f972388f80a9e51612cad4c1bc3877c71c107e46",center:[m,h],zoom:9}),p=new window.vietmapgl.Marker().setLngLat([m,h]).addTo(t);T(p),S(t),t.on("click",u=>{const{lng:C,lat:A}=u.lngLat;p.setLngLat([C,A])})}else console.error("VietMap API không tải được")},[h,m,w]);const i=async t=>{const p=t.target.value;if(I(p),p.length>2)try{const C=await(await fetch(`https://maps.vietmap.vn/api/search/v3?apikey=9e37b843f972388f80a9e51612cad4c1bc3877c71c107e46&text=${p}`)).json();f(C||[])}catch(u){console.error("Lỗi khi tìm kiếm địa điểm:",u)}else f([])},c=async(t,p)=>{try{const u=await fetch(`https://maps.vietmap.vn/api/place/v3?apikey=9e37b843f972388f80a9e51612cad4c1bc3877c71c107e46&refid=${p}`);if(!u.ok){console.error("Lỗi API:",u.status,u.statusText);return}const C=await u.json();if(C&&C.lng&&C.lat){const{lng:A,lat:R}=C;w&&b&&(b.setLngLat([A,R]),k.flyTo({center:[A,R],zoom:500})),x(A.toString(),R.toString());const D=t||`${C.result.district}, ${C.result.city}`;console.log("Địa chỉ đầy đủ:",D)}else console.error("Dữ liệu không hợp lệ từ API: Không tìm thấy tọa độ.",C)}catch(u){console.error("Lỗi khi lấy tọa độ từ API:",u)}},y=()=>{if(b){const{lng:t,lat:p}=b.getLngLat();x(t.toString(),p.toString()),o()}};return e.jsxs("div",{children:[e.jsx("input",{type:"text",value:L,onChange:i,placeholder:"Nhập địa chỉ..."}),v.length>0&&e.jsx("div",{style:{maxHeight:"200px",overflowY:"auto",border:"1px solid #ccc"},children:v.map(t=>e.jsx("div",{style:{padding:"8px",cursor:"pointer"},onClick:()=>c(t.address,t.ref_id),children:t.display},t.ref_id))}),e.jsx("div",{ref:r,style:{width:"100%",height:"300px"}}),e.jsxs("div",{className:"map-actions",children:[e.jsx("button",{onClick:y,className:"btn-select",children:"Select Location"}),e.jsx("button",{onClick:o,className:"btn-close",children:"Close"})]})]})};function ie({open:h,onClose:m,onPlaceCreated:x}){const[o,r]=n.useState({wardId:"",timeOpen:"",timeClose:"",longitude:"",latitude:"",contactLink:"",tags:[],placeTranslations:[],photoDisplay:null,placeMedia:[],isVerified:!1,status:"0"}),[w,j]=n.useState([]),[b,T]=n.useState(!1),[k,S]=n.useState(""),[v,f]=n.useState(""),L=(s,a)=>{S(s),f(a)},I=()=>{T(!0)},i=()=>{T(!1)};n.useEffect(()=>{(async()=>{try{const a=await F.get("https://api.localtour.space/api/Tag/getAll");j(a.data.items)}catch(a){console.error("Error fetching tags:",a)}})()},[]);const c=(s,a)=>{const{name:l,value:g}=s.target;r(a!==void 0?d=>{const N=[...d.placeTranslations];return N[a]={...N[a],[l]:g},{...d,placeTranslations:N}}:d=>({...d,[l]:g}))},y=s=>{const a=s.target.files;a&&a[0]&&r(l=>({...l,photoDisplay:a[0]}))},t=(s,a)=>{const l=s.target.files;l&&l.length>0?r(g=>{const d=[...g.placeMedia];return d[a]=l[0],{...g,placeMedia:d}}):r(g=>{const d=[...g.placeMedia];return d[a]=null,{...g,placeMedia:d}})},p=()=>{r(s=>({...s,placeTranslations:[...s.placeTranslations,{languageCode:"",name:"",description:"",address:"",contact:""}]}))},u=s=>{r(a=>{const l=a.placeTranslations.filter((g,d)=>d!==s);return{...a,placeTranslations:l}})},C=()=>{r(s=>({...s,placeMedia:[...s.placeMedia,null]}))},A=s=>{r(a=>{const l=a.placeMedia.filter((g,d)=>d!==s);return{...a,placeMedia:l}})},R=(s,a)=>{r(l=>({...l,tags:a.map(g=>g.id)}))},D=async()=>{try{const s=localStorage.getItem("accessToken"),a=new FormData;a.append("WardId",o.wardId),a.append("TimeOpen",o.timeOpen),a.append("TimeClose",o.timeClose),a.append("Longitude",o.longitude),a.append("Latitude",o.latitude),a.append("ContactLink",o.contactLink),o.tags.forEach(d=>{a.append("Tags",d)}),o.placeTranslations.forEach(d=>{a.append("PlaceTranslation",JSON.stringify(d))}),o.photoDisplay&&a.append("PhotoDisplay",o.photoDisplay),o.placeMedia.forEach((d,N)=>{d&&a.append("PlaceMedia",d)});const g=(await F.post("https://api.localtour.space/api/Place/create",a,{headers:{Authorization:`Bearer ${s}`,"Content-Type":"multipart/form-data"}})).data;console.log("newPlace",g),alert("Place created successfully!"),x(g),m()}catch(s){console.error("Error creating place:",s),alert("Failed to create place.")}};return e.jsxs($,{open:h,onClose:m,maxWidth:"sm",fullWidth:!0,children:[e.jsx(O,{children:"New Place"}),e.jsxs(E,{children:[e.jsx(P,{fullWidth:!0,label:"Ward ID",name:"wardId",value:o.wardId,onChange:c,margin:"normal"}),e.jsx(P,{fullWidth:!0,label:"Time Open",name:"timeOpen",type:"time",value:o.timeOpen,onChange:c,margin:"normal",inputProps:{step:300}}),e.jsx(P,{fullWidth:!0,label:"Time Close",name:"timeClose",type:"time",value:o.timeClose,onChange:c,margin:"normal",inputProps:{step:300}}),e.jsx(P,{fullWidth:!0,label:"Longitude",name:"longitude",value:k,onChange:s=>S(s.target.value),margin:"normal"}),e.jsx(P,{fullWidth:!0,label:"Latitude",name:"latitude",value:v,onChange:s=>f(s.target.value),margin:"normal"}),e.jsx(M,{onClick:I,variant:"outlined",children:"Choose on Map"}),e.jsxs($,{open:b,onClose:()=>T(!1),maxWidth:"md",fullWidth:!0,children:[e.jsx(O,{children:"Select Location on Map"}),e.jsx(E,{children:e.jsx(ce,{latitude:parseFloat(v)||10.762622,longitude:parseFloat(k)||106.827153,onLocationSelect:L,onCloseMap:i})})]}),e.jsx(P,{fullWidth:!0,label:"Contact Link",name:"contactLink",value:o.contactLink,onChange:c,margin:"normal"}),e.jsx(te,{multiple:!0,id:"tags",options:w,getOptionLabel:s=>s.tagName,onChange:R,renderInput:s=>e.jsx(P,{...s,label:"Tags"})}),e.jsxs("div",{style:{marginTop:"20px"},children:[e.jsx("div",{style:{fontWeight:"bold"},children:"Photo Display"}),e.jsx("input",{type:"file",accept:"image/*",id:"photoDisplay",onChange:y})]}),e.jsxs("div",{style:{marginTop:"20px"},children:[e.jsx(M,{variant:"outlined",onClick:C,children:"Add Place Media"}),o.placeMedia.map((s,a)=>e.jsxs(W,{container:!0,spacing:2,alignItems:"center",style:{marginTop:"10px"},children:[e.jsxs(W,{item:!0,children:[e.jsxs("label",{htmlFor:`placeMedia-${a}`,children:["Media ",a+1]}),e.jsx("input",{type:"file",accept:"image/*",id:`placeMedia-${a}`,onChange:l=>t(l,a)})]}),e.jsx(W,{item:!0,children:e.jsx(M,{variant:"contained",color:"error",onClick:()=>A(a),children:"Remove"})})]},a))]}),e.jsxs("div",{style:{marginTop:"20px"},children:[e.jsx(M,{variant:"outlined",onClick:p,children:"Add Place Translation"}),o.placeTranslations.map((s,a)=>e.jsxs("div",{style:{marginTop:"15px"},children:[e.jsx(P,{fullWidth:!0,label:`Language Code ${a+1}`,name:"languageCode",value:s.languageCode,onChange:l=>c(l,a),margin:"normal"}),e.jsx(P,{fullWidth:!0,label:`Name ${a+1}`,name:"name",value:s.name,onChange:l=>c(l,a),margin:"normal"}),e.jsx(P,{fullWidth:!0,label:`Description ${a+1}`,name:"description",value:s.description,onChange:l=>c(l,a),margin:"normal"}),e.jsx(P,{fullWidth:!0,label:`Address ${a+1}`,name:"address",value:s.address,onChange:l=>c(l,a),margin:"normal"}),e.jsx(P,{fullWidth:!0,label:`Contact ${a+1}`,name:"contact",value:s.contact,onChange:l=>c(l,a),margin:"normal"}),e.jsx(M,{variant:"outlined",color:"error",onClick:()=>u(a),style:{marginTop:"10px"},children:"Remove Translation"})]},a))]})]}),e.jsxs(ae,{children:[e.jsx(M,{onClick:m,color:"secondary",children:"Cancel"}),e.jsx(M,{onClick:D,color:"primary",children:"Submit"})]})]})}const de=async(h=1,m=5,x="vi")=>{const o=localStorage.getItem("accessToken");if(console.log("Access Token:",o),!o)return console.error("No access token found"),{items:[],totalCount:0};try{const r=await F.get(`https://api.localtour.space/api/Place/getAllByRole?LanguageCode=${x}&Page=${h}&Size=${m}`,{headers:{Authorization:`Bearer ${o}`}});return console.log("API Response:",r.data),{items:r.data.items,totalCount:r.data.totalCount}}catch(r){return console.error("Error fetching places",r),{items:[],totalCount:0}}};function pe(){const[h,m]=n.useState([]),[x,o]=n.useState(0),[r,w]=n.useState(""),[j,b]=n.useState("vi"),[T,k]=n.useState(!1),[S,v]=n.useState(1),[f,L]=n.useState(5);n.useEffect(()=>{(async()=>{const{items:p,totalCount:u}=await de(S,f,j);m(p),o(u)})()},[S,f,j]);const I=t=>{const p={...t,status:t.status??"0",isVerified:t.isVerified??!1};m(u=>[...u,p]),o(u=>u+1)},i=ue(),c=q({inputData:h,comparator:J(i.order,i.orderBy),filterName:r}),y=!c.length&&!!r;return e.jsxs(B,{children:[e.jsxs(V,{display:"flex",alignItems:"center",mb:5,children:[e.jsx(z,{variant:"h4",flexGrow:1,children:"Places"}),e.jsx(M,{variant:"contained",color:"inherit",startIcon:e.jsx(G,{icon:"mingcute:add-line"}),onClick:()=>k(!0),children:"New place"})]}),e.jsxs(se,{children:[e.jsx(K,{numSelected:i.selected.length,filterName:r,onFilterName:t=>{w(t.target.value),i.onResetPage()}}),e.jsx(H,{children:e.jsx(ne,{sx:{overflow:"unset"},children:e.jsxs(oe,{sx:{minWidth:800},children:[e.jsx(Y,{order:i.order,orderBy:i.orderBy,rowCount:h.length,numSelected:i.selected.length,onSort:i.onSort,onSelectAllRows:t=>i.onSelectAllRows(t,h.map(p=>p.id)),headLabel:[{id:"name",label:"Name"},{id:"address",label:"Address"},{id:"description",label:"Description"},{id:"isVerify",label:"isVerify"},{id:"status",label:"Status"},{id:"View details",label:"View details"},{id:""}]}),e.jsxs(le,{children:[c.slice(i.page*f,i.page*f+f).map(t=>e.jsx(U,{row:t,selected:i.selected.includes(t.id),onSelectRow:()=>i.onSelectRow(t.id)},t.id)),e.jsx(X,{height:68,emptyRows:Z(i.page,i.rowsPerPage,h.length)}),y&&e.jsx(ee,{searchQuery:r})]})]})})}),e.jsx(re,{component:"div",page:S-1,count:x,rowsPerPage:f,onPageChange:(t,p)=>v(p+1),rowsPerPageOptions:[5,10,25],onRowsPerPageChange:t=>{L(parseInt(t.target.value,10)),v(1)}})]}),e.jsx(ie,{open:T,onClose:()=>k(!1),onPlaceCreated:I})]})}function ue(){const[h,m]=n.useState(0),[x,o]=n.useState("name"),[r,w]=n.useState(5),[j,b]=n.useState([]),[T,k]=n.useState("asc"),S=n.useCallback(c=>{k(x===c&&T==="asc"?"desc":"asc"),o(c)},[T,x]),v=n.useCallback((c,y)=>{if(c){b(y);return}b([])},[]),f=n.useCallback(c=>{const y=j.includes(c)?j.filter(t=>t!==c):[...j,c];b(y)},[j]),L=n.useCallback(()=>{m(0)},[]),I=n.useCallback((c,y)=>{m(y)},[]),i=n.useCallback(c=>{w(parseInt(c.target.value,10)),L()},[L]);return{page:h,order:T,onSort:S,orderBy:x,selected:j,rowsPerPage:r,onSelectRow:f,onResetPage:L,onChangePage:I,onSelectAllRows:v,onChangeRowsPerPage:i}}function we(){return e.jsxs(e.Fragment,{children:[e.jsx(_,{children:e.jsxs("title",{children:[" ",`Places Created - ${Q.appName}`]})}),e.jsx(pe,{})]})}export{we as default};
