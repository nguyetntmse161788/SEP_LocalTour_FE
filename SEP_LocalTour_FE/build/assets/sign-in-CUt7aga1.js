import{g as M,a as W,r as l,a1 as F,a2 as D,u as J,_ as U,a3 as z,b as x,j as e,q as _,a4 as S,c as G,s as A,h as H,a5 as Y,a6 as j,a7 as R,B,T as L,L as q,F as V,R as k,I as T,t as K,H as Q}from"./index-H6gA5qqD.js";import{C as X}from"./config-global-BwHnWRtc.js";import{T as $}from"./TextField-B4jFzzzA.js";import"./InputLabel-UMCnBBYb.js";function Z(t){return M("MuiLoadingButton",t)}const g=W("MuiLoadingButton",["root","loading","loadingIndicator","loadingIndicatorCenter","loadingIndicatorStart","loadingIndicatorEnd","endIconLoadingEnd","startIconLoadingStart"]),oo=["children","disabled","id","loading","loadingIndicator","loadingPosition","variant"],to=t=>{const{loading:o,loadingPosition:c,classes:u}=t,f={root:["root",o&&"loading"],startIcon:[o&&`startIconLoading${S(c)}`],endIcon:[o&&`endIconLoading${S(c)}`],loadingIndicator:["loadingIndicator",o&&`loadingIndicator${S(c)}`]},d=G(f,Z,u);return x({},u,d)},eo=t=>t!=="ownerState"&&t!=="theme"&&t!=="sx"&&t!=="as"&&t!=="classes",no=A(H,{shouldForwardProp:t=>eo(t)||t==="classes",name:"MuiLoadingButton",slot:"Root",overridesResolver:(t,o)=>[o.root,o.startIconLoadingStart&&{[`& .${g.startIconLoadingStart}`]:o.startIconLoadingStart},o.endIconLoadingEnd&&{[`& .${g.endIconLoadingEnd}`]:o.endIconLoadingEnd}]})(({ownerState:t,theme:o})=>x({[`& .${g.startIconLoadingStart}, & .${g.endIconLoadingEnd}`]:{transition:o.transitions.create(["opacity"],{duration:o.transitions.duration.short}),opacity:0}},t.loadingPosition==="center"&&{transition:o.transitions.create(["background-color","box-shadow","border-color"],{duration:o.transitions.duration.short}),[`&.${g.loading}`]:{color:"transparent"}},t.loadingPosition==="start"&&t.fullWidth&&{[`& .${g.startIconLoadingStart}, & .${g.endIconLoadingEnd}`]:{transition:o.transitions.create(["opacity"],{duration:o.transitions.duration.short}),opacity:0,marginRight:-8}},t.loadingPosition==="end"&&t.fullWidth&&{[`& .${g.startIconLoadingStart}, & .${g.endIconLoadingEnd}`]:{transition:o.transitions.create(["opacity"],{duration:o.transitions.duration.short}),opacity:0,marginLeft:-8}})),so=A("span",{name:"MuiLoadingButton",slot:"LoadingIndicator",overridesResolver:(t,o)=>{const{ownerState:c}=t;return[o.loadingIndicator,o[`loadingIndicator${S(c.loadingPosition)}`]]}})(({theme:t,ownerState:o})=>x({position:"absolute",visibility:"visible",display:"flex"},o.loadingPosition==="start"&&(o.variant==="outlined"||o.variant==="contained")&&{left:o.size==="small"?10:14},o.loadingPosition==="start"&&o.variant==="text"&&{left:6},o.loadingPosition==="center"&&{left:"50%",transform:"translate(-50%)",color:(t.vars||t).palette.action.disabled},o.loadingPosition==="end"&&(o.variant==="outlined"||o.variant==="contained")&&{right:o.size==="small"?10:14},o.loadingPosition==="end"&&o.variant==="text"&&{right:6},o.loadingPosition==="start"&&o.fullWidth&&{position:"relative",left:-10},o.loadingPosition==="end"&&o.fullWidth&&{position:"relative",right:-10})),io=l.forwardRef(function(o,c){const u=l.useContext(F),f=D(u,o),d=J({props:f,name:"MuiLoadingButton"}),{children:I,disabled:y=!1,id:v,loading:p=!1,loadingIndicator:m,loadingPosition:P="center",variant:b="text"}=d,w=U(d,oo),s=z(v),i=m??e.jsx(_,{"aria-labelledby":s,color:"inherit",size:16}),n=x({},d,{disabled:y,loading:p,loadingIndicator:i,loadingPosition:P,variant:b}),a=to(n),h=p?e.jsx(so,{className:a.loadingIndicator,ownerState:n,children:i}):null;return e.jsxs(no,x({disabled:y||p,id:s,ref:c},w,{variant:b,classes:a,ownerState:n,children:[n.loadingPosition==="end"?I:h,n.loadingPosition==="end"?h:I]}))});function ao(){const t=Y(),[o,c]=l.useState(""),[u,f]=l.useState(""),[d,I]=l.useState(!1),[y,v]=l.useState(!1),[p,m]=l.useState(""),P=l.useCallback(async()=>{const s=j.get("refreshToken");if(!s)return null;try{const n=await(await fetch("https://api.localtour.space/api/Authen/refreshToken",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({token:s})})).json(),{accessToken:a,refreshToken:h}=n.accessToken;localStorage.setItem("accessToken",a),localStorage.setItem("userId",n.userId),j.set("refreshToken",n.refreshToken,{expires:7,path:"/"});const r=R(n.accessToken),C=Array.isArray(r["http://schemas.microsoft.com/ws/2008/06/identity/claims/role"])?r["http://schemas.microsoft.com/ws/2008/06/identity/claims/role"]:[r["http://schemas.microsoft.com/ws/2008/06/identity/claims/role"]],N=["Administrator","Moderator","Service Owner"],E=C.filter(O=>N.includes(O));if(E.length===0)throw new Error("You do not have permission to access this page");return localStorage.setItem("user",JSON.stringify(n)),localStorage.setItem("role",JSON.stringify(E)),localStorage.setItem("currentPath","/"),j.set("refreshToken",h,{expires:7,path:"/"}),a}catch(i){console.error("Refresh token failed:",i),t.push("/sign-in")}},[t]);l.useEffect(()=>{const s=localStorage.getItem("accessToken"),i=localStorage.getItem("user"),n=localStorage.getItem("currentPath")||"/";if(s&&i)try{const a=R(s),h=Math.floor(Date.now()/1e3);a.exp&&a.exp>h?t.replace(n):P().then(r=>{r?t.replace(n):(localStorage.clear(),t.push("/sign-in"))})}catch(a){console.error("Invalid token:",a),localStorage.clear(),t.push("/sign-in")}},[t,P]);const b=l.useCallback(async()=>{v(!0),m("");try{const s=await fetch("https://api.localtour.space/api/Authen/login",{method:"POST",headers:{Accept:"*/*","Content-Type":"application/json"},body:JSON.stringify({phoneNumber:o,password:u})});if(!s.ok)throw new Error("Failed to sign in");const i=await s.json();localStorage.setItem("accessToken",i.accessToken),localStorage.setItem("userId",i.userId),j.set("refreshToken",i.refreshToken,{expires:7,path:"/"});const n=R(i.accessToken),a=Array.isArray(n["http://schemas.microsoft.com/ws/2008/06/identity/claims/role"])?n["http://schemas.microsoft.com/ws/2008/06/identity/claims/role"]:[n["http://schemas.microsoft.com/ws/2008/06/identity/claims/role"]],h=["Administrator","Moderator","Service Owner"],r=a.filter(C=>h.includes(C));if(r.length===0)throw new Error("You do not have permission to access this page");localStorage.setItem("user",JSON.stringify(i)),localStorage.setItem("role",JSON.stringify(r)),localStorage.setItem("currentPath","/"),r.includes("Administrator")?t.replace("/"):r.includes("Moderator")?t.replace("/place"):r.includes("Service Owner")&&t.replace("/owner/place")}catch(s){m(s.message||"Invalid phone number or password")}finally{v(!1)}},[o,u,t]),w=e.jsxs(B,{display:"flex",flexDirection:"column",alignItems:"flex-end",children:[e.jsx($,{fullWidth:!0,name:"phoneNumber",label:"Phone Number",value:o,onChange:s=>c(s.target.value),InputLabelProps:{shrink:!0},sx:{mb:3}}),e.jsx($,{fullWidth:!0,name:"password",label:"Password",value:u,onChange:s=>f(s.target.value),InputLabelProps:{shrink:!0},type:d?"text":"password",InputProps:{endAdornment:e.jsx(V,{position:"end",children:e.jsx(k,{onClick:()=>I(!d),edge:"end",children:e.jsx(T,{icon:d?"solar:eye-bold":"solar:eye-closed-bold"})})})},sx:{mb:3}}),p&&e.jsx(L,{color:"error",sx:{mb:2},children:p}),e.jsx(io,{fullWidth:!0,size:"large",type:"button",color:"inherit",variant:"contained",onClick:b,loading:y,children:"Sign in"})]});return e.jsxs(e.Fragment,{children:[e.jsxs(B,{gap:1.5,display:"flex",flexDirection:"column",alignItems:"center",sx:{mb:5},children:[e.jsx(L,{variant:"h5",children:"Sign in"}),e.jsxs(L,{variant:"body2",color:"text.secondary",children:["Donâ€™t have an account?",e.jsx(q,{variant:"subtitle2",sx:{ml:.5},children:"Get started"})]})]}),w,e.jsx(K,{sx:{my:3,"&::before, &::after":{borderTopStyle:"dashed"}},children:e.jsx(L,{variant:"overline",sx:{color:"text.secondary",fontWeight:"fontWeightMedium"},children:"OR"})}),e.jsxs(B,{gap:1,display:"flex",justifyContent:"center",children:[e.jsx(k,{color:"inherit",children:e.jsx(T,{icon:"logos:google-icon"})}),e.jsx(k,{color:"inherit",children:e.jsx(T,{icon:"eva:github-fill"})}),e.jsx(k,{color:"inherit",children:e.jsx(T,{icon:"ri:twitter-x-fill"})})]})]})}function uo(){return e.jsxs(e.Fragment,{children:[e.jsx(Q,{children:e.jsxs("title",{children:[" ",`Sign in - ${X.appName}`]})}),e.jsx(ao,{})]})}export{uo as default};
